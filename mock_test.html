<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Thử kiểm tra — Quiz App</title>
  <link rel="stylesheet" href="style.css">
  <script>
    // Lấy môn từ query param hoặc localStorage
    (function(){
      const params = new URLSearchParams(location.search);
      const subParam = params.get('subject');
      const stored = localStorage.getItem('quiz_subject');
      const subject = subParam || stored || 'hoahoc';

      try { localStorage.setItem('quiz_subject', subject); } catch(e){}

      window.QUIZ_SUBJECT = subject;
      window.QUESTIONS_FILE = `question/questions_${subject}.json`;
      window.MOCK_TEST = true; // flag để biết đây là mock test
      console.log('Mock Test - subject=', subject);
    })();
  </script>
</head>
<body>
  <div class="container">
    <h1>Thử kiểm tra — <span id="subject-name"></span></h1>

    <div id="quiz-box">
      <!-- Timer và thông tin -->
      <div class="top-controls" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding:12px;background:#f0f8ff;border-radius:8px;border:1px solid #b0d4ff;">
        <div style="font-weight:600;">
          Câu hỏi: <span id="question-count">1</span>/60
        </div>
        <div style="font-weight:600;color:#d9534f;">
          Thời gian: <span id="timer">45:00</span>
        </div>
        <button id="submit-test" class="btn-submit" aria-label="Nộp bài">Nộp bài</button>
      </div>

      <!-- Danh sách câu hỏi (mini view) -->
      <div id="question-list" class="question-list" style="background:#f8f8f8;border-radius:8px;padding:8px;border:1px solid #e0e0e0;margin-bottom:18px;overflow-x:auto;">
        <div id="question-list-inner" style="min-width:600px;display:flex;gap:4px;flex-wrap:wrap;"></div>
      </div>

      <!-- Câu hỏi chính -->
      <div class="card" style="background:#fff;border-radius:8px;padding:24px;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,.07);">
        <div id="question" class="question-title" aria-live="polite" style="margin-bottom:12px;font-weight:700;font-size:18px;"></div>
        <div id="answers" class="answers"></div>

        <div class="actions" style="display:flex;gap:12px;margin-top:12px;">
          <button id="prev" class="nav-btn">Câu trước</button>
          <button id="next" class="nav-btn">Câu tiếp</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Hiển thị tên môn
    (function(){
      const map = { tin:'Tin học', vatly:'Vật lý', hoahoc:'Hoá học', chinhttri:'Chính trị', sinhhoc:'Sinh học' };
      const sub = window.QUIZ_SUBJECT || 'hoahoc';
      const el = document.getElementById('subject-name');
      if (el) el.textContent = map[sub] || sub;
    })();

    // Biến toàn cục
    let questions = [];
    let selected = [];
    let current = 0;
    let timerInterval = null;
    let timeLeft = 45 * 60; // 45 phút (tính bằng giây)
    let submitted = false; // true sau khi nộp bài

    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');

    document.addEventListener("keydown", function (event) {

    if (event.key === "ArrowRight") {
        nextBtn.click();
    };
    if (event.key === "ArrowLeft") {
        prevBtn.click();
    };
  });

  document.addEventListener("keydown", function (e) {
    console.log("Key:", e.key);

    const index = parseInt(e.key) - 1;
    if (isNaN(index)) return;

    const buttons = document.querySelectorAll("#answers label");
    if (index >= 0 && index < buttons.length) {
        buttons[index].click();
    }
  });

    // Hàm shuffle array
    function shuffleArray(arr) {
      const result = [...arr];
      for (let i = result.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [result[i], result[j]] = [result[j], result[i]];
      }
      return result;
    }

    // Load câu hỏi và chọn random 60 câu
    (function loadQuestions() {
      const questionsFile = window.QUESTIONS_FILE;

      fetch(questionsFile)
        .then(res => {
          if (!res.ok) throw new Error('Not found');
          return res.json();
        })
        .then(data => {
          let allQuestions = Array.isArray(data) ? data : [];
          console.log('Tổng câu hỏi:', allQuestions.length);

          // Lấy random 60 câu (hoặc ít hơn nếu không đủ)
          const shuffled = shuffleArray(allQuestions);
          questions = shuffled.slice(0, 80);
          console.log('Random 60 câu:', questions.length);

          // Khởi tạo mảng selected
          selected = Array(questions.length).fill(undefined);
          current = 0;

          renderQuestion();
          renderQuestionList();
          startTimer();
        })
        .catch(err => {
          console.error('Lỗi load câu hỏi:', err);
          const questionEl = document.getElementById('question');
          if (questionEl) questionEl.textContent = 'Lỗi khi tải câu hỏi.';
        });
    })();

    // Render câu hỏi hiện tại
    function renderQuestion() {
      if (!questions.length) return;

      const q = questions[current];
      const questionEl = document.getElementById('question');
      const answersEl = document.getElementById('answers');
      const countEl = document.getElementById('question-count');

      questionEl.innerHTML = `<strong>Câu ${current + 1}:</strong> ${q.question || ''}`;
      countEl.textContent = current + 1;

      answersEl.innerHTML = '';
      if (q.answers && Array.isArray(q.answers)) {
        q.answers.forEach((answer, idx) => {
          const isSelected = selected[current] === idx;
          const correctIdx = q.correct;

          // Compute styles depending on submission state
          let bg = isSelected ? '#e3f2fd' : '#fff';
          let borderColor = isSelected ? '#2196F3' : '#ddd';
          let markerHTML = '';

          if (submitted) {
            // Disable selecting after submission
            if (idx === correctIdx) {
              bg = '#e8f5e9'; borderColor = '#0000FF';
              markerHTML = '';
            } else if (isSelected && idx !== correctIdx) {
              bg = '#ffebee'; borderColor = '#FF0000';
              markerHTML = `<span style="float:right;color:#c62828;font-weight:700">Sai</span>`;
            } else {
              bg = '#fff'; borderColor = '#ddd';
            }
          }

          const label = document.createElement('label');
          label.className = 'answer-option';
          label.style.cssText = `
            display:block;padding:10px;margin:8px 0;border:2px solid ${borderColor};border-radius:6px;cursor:pointer;
            background:${bg};
          `;

          label.innerHTML = `
            <input type="radio" name="answer" value="${idx}" ${isSelected ? 'checked' : ''} ${submitted ? 'disabled' : ''} style="margin-right:8px;"/>
            ${answer}
            ${markerHTML}
          `;

          label.addEventListener('change', () => {
            if (submitted) return; // không cho sửa sau khi nộp
            selected[current] = parseInt(idx);
            renderQuestion();
            renderQuestionList();
          });
          answersEl.appendChild(label);
        });
      }

      // Show explanation after submission
      if (submitted && q.explanation) {
        const exDiv = document.createElement('div');
        exDiv.className = 'question-explanation';
        exDiv.style.cssText = 'margin-top:12px;padding:12px;background:#fff8e1;border-left:4px solid #ffca28;border-radius:4px;color:#333;';
        exDiv.innerHTML = `<strong>Lời giải:</strong> ${q.explanation || ''}`;
        answersEl.appendChild(exDiv);
      }

      // Update button states
      document.getElementById('prev').disabled = current === 0;
      document.getElementById('next').disabled = current === questions.length - 1;
    }

    // Render danh sách câu hỏi mini
    function renderQuestionList() {
      const listEl = document.getElementById('question-list-inner');
      listEl.innerHTML = '';

      questions.forEach((_, idx) => {
        const btn = document.createElement('button');
        btn.className = 'question-btn';
        btn.textContent = idx + 1;

        // Determine colors
        let bg = '#fff';
        let color = '#000';
        if (current === idx) {
          bg = '#2196F3'; color = '#fff';
        } else if (submitted) {
          const isSelected = selected[idx];
          const isCorrect = selected[idx] === questions[idx].correct;
          if (isCorrect) { bg = '#4CAF50'; color = '#fff'; }
          else if (selected[idx] === undefined) { bg = '#9e9e9e'; color = '#fff'; } // unanswered
          else { bg = '#f44336'; color = '#fff'; } // wrong
        } else {
          bg = selected[idx] !== undefined ? '#4CAF50' : '#fff';
          color = selected[idx] !== undefined ? '#fff' : '#000';
        }

        btn.style.cssText = `
          width:40px;height:40px;padding:0;border-radius:4px;border:2px solid #ddd;cursor:pointer;
          background:${bg};
          color:${color};font-weight:600;
        `;
        btn.addEventListener('click', () => {
          current = idx;
          renderQuestion();
          renderQuestionList(); // update highlight and auto-scroll
        });
        listEl.appendChild(btn);
      });

      // Auto-scroll the current question button into view (centered)
      const currentBtn = listEl.children[current];
      if (currentBtn) {
        try {
          currentBtn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        } catch (e) {
          // Fallback for older browsers: center via scrollLeft
          const listRect = listEl.getBoundingClientRect();
          const btnRect = currentBtn.getBoundingClientRect();
          const offset = (btnRect.left + btnRect.right) / 2 - (listRect.left + listRect.right) / 2;
          listEl.scrollLeft += offset;
        }
      }
    }

    // Timer countdown
    function startTimer() {
      timerInterval = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById('timer').textContent = 
          `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          submitTest();
        }
      }, 1000);
    }

    // Navigation
    document.getElementById('prev').addEventListener('click', () => {
      if (current > 0) {
        current--;
        renderQuestion();
        renderQuestionList();
      }
    });

    document.getElementById('next').addEventListener('click', () => {
      if (current < questions.length - 1) {
        current++;
        renderQuestion();
        renderQuestionList();
      }
    });

    // Submit test
    function submitTest() {
      if (submitted) return;
      clearInterval(timerInterval);
      const correct = selected.reduce((sum, ans, idx) => {
        return sum + (ans === questions[idx].correct ? 1 : 0);
      }, 0);

      const score = Math.round((correct / questions.length) * 100);
      
      // Lưu kết quả
      try {
        localStorage.setItem('mock_test_result', JSON.stringify({
          subject: window.QUIZ_SUBJECT,
          total: questions.length,
          correct: correct,
          score: score,
          date: new Date().toLocaleString('vi-VN')
        }));
      } catch(e){}

      // Hiển thị kết quả trên trang và đánh dấu câu sai
      submitted = true;
      document.getElementById('submit-test').disabled = true;
      // Show result panel above quiz
      let panel = document.getElementById('result-panel');
      if (!panel) {
        panel = document.createElement('div');
        panel.id = 'result-panel';
        panel.style.cssText = 'margin:12px 0;padding:12px;border-radius:6px;background:#fff3cd;border:1px solid #ffeeba;font-weight:600;';
        document.querySelector('.container').insertBefore(panel, document.getElementById('quiz-box'));
      }
      panel.innerHTML = `Kết quả: <strong>${correct}/${questions.length}</strong> câu đúng (${score}%). <button id="return-home" style="margin-left:12px;">Quay về trang chủ</button>`;

      document.getElementById('return-home').addEventListener('click', () => {
        window.location.href = 'index.html';
      });

      renderQuestion();
      renderQuestionList();

      // Focus first wrong question if any
      const firstWrong = selected.findIndex((ans, idx) => ans !== questions[idx].correct);
      if (firstWrong >= 0) {
        current = firstWrong;
        renderQuestion();
        renderQuestionList();
      }
    }

    document.getElementById('submit-test').addEventListener('click', submitTest);
  </script>
</body>
</html>
